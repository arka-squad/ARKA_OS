# Audit de structure ARKA_OS — checklist-audit-arka-v1

## Résumé exécutif
- La séparation core / profils / agent est formalisée via des assemblies hiérarchisés et des contrats de dépendances, ce qui fournit une base cohérente pour la gouvernance multi-briques.【F:ARKA_CORE/master-assembly.yaml†L1-L49】
- Les briques constitutionnelles exposent des contrats explicites (workflows, règles globales, mémoire, bus d’événements) mais plusieurs incohérences de câblage et de packaging rendent l’assemblage incomplet (glob build partiel, scripts non résolus, doublons de droits).【F:bin/os-build.sh†L1-L17】【F:ARKA_CORE/ARKA_EXT/ARKAEXT01-SUBS-CI.yaml†L1-L17】【F:ARKA_PROFIL/bricks/ARKPR05-RIGHTS.yaml†L6-L47】
- Les profils, wake-ups et capacités sont riches mais présentent des divergences (profils citant des action_sets inexistants, wake-up/intents sans validation croisée) qui fragilisent l’application des politiques RBAC et l’orchestration agent/wake-up.【F:ARKA_PROFIL/bricks/ARKPR03-ACTION-SETS.yaml†L5-L24】【F:ARKA_PROFIL/bricks/ARKPR05-RIGHTS.yaml†L6-L114】【F:ARKA_AGENT/client/acme/wakeup/ARKAA08-WAKEUP-TECHNICAL_ARCHITECT.yaml†L1-L35】

## Points forts
- **Assemblage modulaire** : l’ordre d’activation des briques core est clairement défini, avec des profils alternatifs (`dev-light`, `strict-security`) qui démontrent l’usage des overrides par environnement.【F:ARKA_CORE/master-assembly.yaml†L22-L44】
- **Contrats transverses explicites** : la hiérarchie, les règles globales, les workflows et les specs d’exécution détaillent rôles, transitions, critères et métriques avec des références croisées, limitant la duplication de logique métier.【F:ARKA_CORE/bricks/ARKORE01-HIERARCHY.yaml†L1-L38】【F:ARKA_CORE/bricks/ARKORE02-GLOBAL-RULES.yaml†L1-L58】【F:ARKA_CORE/bricks/ARKORE04-WORKFLOWS.yaml†L1-L93】【F:ARKA_CORE/bricks/ARKORE05-EXECUTION-SPECS.yaml†L1-L33】
- **Instrumentation mémoire & events** : la brique mémoire formalise schémas, hooks et rétention, tandis que le bus d’événements impose des topics, schémas et subscriptions cohérents, en forçant la propagation des mises à jour mémoire.【F:ARKA_CORE/bricks/ARKORE14-MEMORY-OPS.yaml†L1-L81】【F:ARKA_CORE/bricks/ARKORE12-ACTION-KEYS.yaml†L20-L137】【F:ARKA_CORE/bricks/ARKORE16-EVENT-BUS.yaml†L1-L93】
- **RBAC structuré** : la politique d’autorisation et le format ARKPR09 décrivent un pipeline d’évaluation déterministe et un mapping compact des permissions, facilitant la traduction vers les action_keys core.【F:ARKA_PROFIL/bricks/ARKPR07-AUTHZ-POLICY.yaml†L1-L17】【F:ARKA_PROFIL/bricks/ARKPR09-PERMISSIONS-FORMAT.yaml†L1-L88】【F:ARKA_AGENT/client/acme/ARKAA19-AGENT-CAPABILITIES.yaml†L1-L118】

## Points faibles ou ambigus
- **Build incomplet** : le script `os-build.sh` ne collecte que les fichiers `client/acme/*.yaml`, excluant les sous-répertoires `experts/` et `wakeup/`. Les assemblies d’agents ne contiendront donc ni experts ni wake-ups dans le bundle final.【F:bin/os-build.sh†L1-L16】
- **Overrides d’extensions non résolus** : l’override `scripts/handlers/` du pack CI et des events pack pointe vers un répertoire racine qui n’existe pas (les scripts sont sous `ARKA_CORE/scripts/handlers`). L’assemblage par défaut référence aussi `on_memory_update.sh` dans `scripts/` alors que le fichier vit dans `ARKA_CORE/scripts/exemples/` ; l’exécution runtime échouera faute de chemin valide.【F:ARKA_CORE/ARKA_EXT/ARKAEXT01-SUBS-CI.yaml†L2-L17】【F:ARKA_AGENT/client/acme/ARKAA12-EVENTS-PACK.yaml†L3-L18】【F:ARKA_CORE/bricks/ARKORE16-EVENT-BUS.yaml†L48-L76】【F:ARKA_CORE/scripts/handlers/us_created__issue_links.js†L1-L51】【F:ARKA_CORE/scripts/handlers/memory_updated__sync_embeddings.sh†L1-L9】【F:ARKA_CORE/scripts/exemples/on_memory_update.sh†L1-L7】
- **Scripts manquants** : la subscription `delivery_received__adr_snapshot.js` déclarée dans le pack ACME n’a pas d’implémentation dans le dépôt, bloquant l’événement `DELIVERY_RECEIVED` sur l’environnement client.【F:ARKA_AGENT/client/acme/ARKAA12-EVENTS-PACK.yaml†L8-L18】
- **Profils incohérents** : `ARKPR05-RIGHTS` déclare deux blocs `agp_rights` contradictoires et référence un set `create_structure` absent de `ARKPR03-ACTION-SETS`, empêchant la résolution complète des droits. Le catalogue ajoute un bloc `agp` qui redéfinit partiellement les mêmes actions, ce qui ouvre la porte à des collisions de configuration.【F:ARKA_PROFIL/bricks/ARKPR05-RIGHTS.yaml†L6-L58】【F:ARKA_PROFIL/bricks/ARKPR03-ACTION-SETS.yaml†L5-L24】【F:ARKA_PROFIL/bricks/ARKPR08-PROFILES-CATALOG.yaml†L5-L27】
- **Assemblage agent redondant** : le master agent active deux fois `ARKAA08-WAKEUP-AGP`, signe d’une duplication involontaire dans la liste `enable`. Cette redondance rend la maintenance des overrides plus difficile et masque les wake-ups réellement nécessaires par environnement.【F:ARKA_AGENT/master-agent.yaml†L11-L41】
- **Wake-ups sans validation croisée** : chaque wake-up référence bien profil, expert et capacités, mais il n’existe pas de mapping consolidé (table de correspondance) garantissant que les `available_intents` exposés par les experts correspondent aux intents autorisés par les profils/guardrails (ex. `PLAN_WORKFLOW`, `REVIEW_DELIVERABLE` communs vs intents spécifiques). L’assemblage actuel repose sur de simples références sans test de cohérence explicite.【F:ARKA_AGENT/client/acme/experts/ARKA_AGENT05-technical-architect.yaml†L1-L61】【F:ARKA_AGENT/client/acme/wakeup/ARKAA08-WAKEUP-TECHNICAL_ARCHITECT.yaml†L1-L35】【F:ARKA_PROFIL/bricks/ARKPR20-WAKEUP-POLICIES.yaml†L1-L16】
- **Handlers inégaux** : les scripts livrés sont des placeholders (echo, TODO), sans journalisation JSON ni validations évoquées dans la charte de qualité ; ils ne respectent pas les conventions de logs attendues pour le bus d’événements.【F:ARKA_CORE/scripts/handlers/memory_updated__sync_embeddings.sh†L1-L9】【F:ARKA_CORE/scripts/handlers/us_created__issue_links.js†L1-L51】

## Recommandations concrètes
1. **Sécuriser le build multi-niveaux**
   - Étendre `bin/os-build.sh` pour inclure récursivement `client/acme/**/*.yaml` et fusionner les outputs dans `build/`, puis ajouter un test de présence des sections `experts`/`wakeup` avant release.【F:bin/os-build.sh†L1-L16】
   - Générer automatiquement les bundles `build/` dans le dépôt (ou via CI) pour détecter tôt les régressions de résolutions de références.

2. **Fiabiliser les overrides et scripts d’extension**
   - Harmoniser `base_dir` sur un chemin réel (`ARKA_CORE/scripts/handlers/`) ou déplacer les scripts dans un dossier racine `scripts/handlers/` pour satisfaire les overrides `ARKAEXT01` et `ARKAA12` ; déplacer `on_memory_update.sh` depuis `exemples/` ou ajuster le dispatch par défaut.【F:ARKA_CORE/ARKA_EXT/ARKAEXT01-SUBS-CI.yaml†L2-L17】【F:ARKA_CORE/bricks/ARKORE16-EVENT-BUS.yaml†L48-L76】【F:ARKA_CORE/scripts/exemples/on_memory_update.sh†L1-L7】
   - Fournir l’implémentation manquante `delivery_received__adr_snapshot.js` ou retirer la subscription pour éviter les hooks fantômes.【F:ARKA_AGENT/client/acme/ARKAA12-EVENTS-PACK.yaml†L8-L18】

3. **Nettoyer la définition des profils/RBAC**
   - Dédupliquer `agp_rights` et introduire officiellement un `create_structure` action_set (ou ajuster les droits) pour que les bundles se résolvent sans erreurs ; ajouter des tests YAML validant l’absence de doublons et la présence des action_sets utilisés.【F:ARKA_PROFIL/bricks/ARKPR03-ACTION-SETS.yaml†L5-L24】【F:ARKA_PROFIL/bricks/ARKPR05-RIGHTS.yaml†L6-L58】
   - Clarifier le bloc `agp` dans `ARKPR08` (utiliser soit `right_ref`, soit une définition inline, mais pas les deux) et documenter la stratégie de tags pour éviter les collisions de profils lors de la sélection des wake-ups.【F:ARKA_PROFIL/bricks/ARKPR08-PROFILES-CATALOG.yaml†L5-L27】

4. **Aligner agents, wake-ups et intents**
   - Ajouter un manifeste (ex. `wakeup-intents.matrix.yaml`) qui agrège pour chaque wake-up les intents exposés par l’expert, ceux autorisés par le profil et ceux whitelistés dans `ARKPR20`, accompagné d’un test de cohérence en CI.【F:ARKA_AGENT/client/acme/experts/ARKA_AGENT05-technical-architect.yaml†L18-L28】【F:ARKA_AGENT/client/acme/wakeup/ARKAA08-WAKEUP-TECHNICAL_ARCHITECT.yaml†L5-L23】【F:ARKA_PROFIL/bricks/ARKPR20-WAKEUP-POLICIES.yaml†L6-L15】
   - Corriger la duplication `ARKAA08-WAKEUP-AGP` dans `master-agent.yaml` et profiter du nettoyage pour grouper les wake-ups par domaine fonctionnel (gouvernance, delivery, marketing…) afin de faciliter les overrides ciblés.【F:ARKA_AGENT/master-agent.yaml†L11-L41】

5. **Renforcer observabilité & logs**
   - Remplacer les placeholders des handlers par des scripts produisant des logs JSON (`{ts, level, msg, event, trace_id}`) et intégrant les validations/retours d’erreur explicités dans les contrats d’événements pour respecter la charte qualité ARKA.【F:ARKA_CORE/scripts/handlers/memory_updated__sync_embeddings.sh†L1-L9】【F:ARKA_CORE/scripts/handlers/us_created__issue_links.js†L1-L51】

6. **Documenter les gaps**
   - Ajouter dans la documentation `Docs/` une section « Assemblage & overrides » détaillant le flux core → profils → agents, les extensions disponibles (`ARKA_EXT`) et la procédure pour ajouter un nouvel environnement, pour guider les contributeurs et éviter les divergences de packaging.【F:ARKA_CORE/master-assembly.yaml†L1-L68】【F:ARKA_CORE/profiles/dev.override.yaml†L1-L7】

